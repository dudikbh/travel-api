<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>×—×™×¤×•×© ××¡×œ×•×œ×™× - ××¢×¨×›×ª ×”×–×× ×ª × ×¡×™×¢×•×ª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app-container">
      <div class="app-header">
        <button onclick="goBack()" class="back-btn">â† ××—×•×¨×”</button>
        <h1>×—×™×¤×•×© ××¡×œ×•×œ×™×</h1>
        <button onclick="logout()" class="logout-btn">×”×ª× ×ª×§</button>
      </div>

      <div class="app-content fade-in">
        <!-- ×—×™×¤×•×© ××¡×œ×•×œ×™× -->
        <div class="card">
          <div class="card-header">×—×¤×© ××¡×œ×•×œ</div>

          <div class="search-container">
            <div class="search-row">
              <div class="form-group">
                <label for="origin">××•×¦×</label>
                <input 
                  type="text" 
                  id="origin" 
                  class="form-input"
                  placeholder="×”×›× ×¡ × ×§×•×“×ª ××•×¦×"
                  list="origins-list"
                />
                <datalist id="origins-list"></datalist>
              </div>

              <div class="form-group">
                <label for="destination">×™×¢×“</label>
                <input 
                  type="text" 
                  id="destination" 
                  class="form-input"
                  placeholder="×”×›× ×¡ × ×§×•×“×ª ×™×¢×“"
                  list="destinations-list"
                />
                <datalist id="destinations-list"></datalist>
              </div>
            </div>

            <div class="search-buttons">
              <button onclick="searchRoute()" class="btn btn-primary">×—×¤×©</button>
              <button onclick="resetSearch()" class="btn btn-secondary">××™×¤×•×¡</button>
            </div>
          </div>
        </div>

        <!-- ×ª×•×¦××•×ª ×—×™×¤×•×© -->
        <div id="search-results" class="card" style="display: none;">
          <div class="card-header">×ª×•×¦××•×ª ×—×™×¤×•×©</div>
          <div id="route-details"></div>

          <!-- ×›×¤×ª×•×¨ ×©×™×ª×•×£ ×œ×•×•×˜×¡××¤ -->
          <div class="share-section" style="text-align: center; margin-top: 20px;">
            <button id="whatsapp-btn" onclick="shareToWhatsApp()" class="whatsapp-btn" style="display: none;">
              <span class="whatsapp-icon">ğŸ“±</span>
              ×©×ª×£ ×‘×•×•×˜×¡××¤
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let allRoutes = [];
      let currentRoute = null;

      function goBack() {
        window.history.back();
      }

      function logout() {
        localStorage.removeItem('savedLogin');
        window.location.href = '/';
      }

      // ××™×¤×•×¡ ×”×—×™×¤×•×©
      function resetSearch() {
        document.getElementById('origin').value = '';
        document.getElementById('destination').value = '';
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('whatsapp-btn').style.display = 'none';
        currentRoute = null;
      }

      // ×˜×¢×™× ×ª ×›×œ ×”××¡×œ×•×œ×™×
      async function loadRoutes() {
        try {
          const response = await fetch('/api/prices');
          const routes = await response.json();
          allRoutes = routes;
          populateDataLists();
        } catch (error) {
          console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¡×œ×•×œ×™×:', error);
        }
      }

      // ××™×œ×•×™ ×¨×©×™××•×ª ×”×©×œ××” ××•×˜×•××˜×™×ª
      function populateDataLists() {
        const origins = new Set();
        const destinations = new Set();

        allRoutes.forEach(route => {
          if (route.route) {
            const parts = route.route.split(' - ');
            if (parts.length === 2) {
              origins.add(parts[0].trim());
              destinations.add(parts[1].trim());
            }
          }
        });

        // ××™×œ×•×™ ×¨×©×™××ª ××•×¦××™×
        const originsList = document.getElementById('origins-list');
        originsList.innerHTML = '';
        origins.forEach(origin => {
          const option = document.createElement('option');
          option.value = origin;
          originsList.appendChild(option);
        });

        // ××™×œ×•×™ ×¨×©×™××ª ×™×¢×“×™×
        const destinationsList = document.getElementById('destinations-list');
        destinationsList.innerHTML = '';
        destinations.forEach(destination => {
          const option = document.createElement('option');
          option.value = destination;
          destinationsList.appendChild(option);
        });
      }

      // ×¤×•× ×§×¦×™×” ×œ× ×¨××•×œ ××¡×œ×•×œ (×›××• ×‘×©×¨×ª)
      function normalizeRoute(origin, destination) {
        const cities = [origin.trim(), destination.trim()].sort();
        return `${cities[0]} - ${cities[1]}`;
      }

      // ×—×™×¤×•×© ××¡×œ×•×œ
      function searchRoute() {
        const origin = document.getElementById('origin').value.trim();
        const destination = document.getElementById('destination').value.trim();

        if (!origin || !destination) {
          alert('×× × ××œ× ××ª ×©×“×•×ª ×”××•×¦× ×•×”×™×¢×“');
          return;
        }

        // × ×¨××•×œ ×”×—×™×¤×•×© - ××¡×“×¨ ××ª ×©×ª×™ ×”×¢×¨×™× ×œ×¤×™ ××œ×¤×‘×™×ª ×›××• ×‘××¡×“ ×”× ×ª×•× ×™×
        const normalizedSearch = normalizeRoute(origin, destination);
        
        // ×—×™×¤×•×© ××“×•×™×§ ×œ×¤×™ ×”× ×¨××•×œ
        let foundRoute = allRoutes.find(route => {
          if (!route.route) return false;
          const routeNormalized = normalizeRoute(
            route.route.split(' - ')[0], 
            route.route.split(' - ')[1]
          );
          return routeNormalized.toLowerCase() === normalizedSearch.toLowerCase();
        });

        if (!foundRoute) {
          // ×—×™×¤×•×© ×’××™×© - ××—×¤×© ××ª ×©×ª×™ ×”×¢×¨×™× ×‘××¡×œ×•×œ ×œ×œ× ×ª×œ×•×ª ×‘×¡×“×¨
          foundRoute = allRoutes.find(route => {
            if (!route.route) return false;
            const routeLower = route.route.toLowerCase();
            const originLower = origin.toLowerCase();
            const destinationLower = destination.toLowerCase();
            
            return routeLower.includes(originLower) && routeLower.includes(destinationLower);
          });
        }

        if (foundRoute) {
          currentRoute = foundRoute;
          displayRouteDetails(foundRoute);
          document.getElementById('whatsapp-btn').style.display = 'inline-block';
        } else {
          document.getElementById('search-results').style.display = 'block';
          document.getElementById('route-details').innerHTML = `
            <div class="no-results">
              <p>×œ× × ××¦× ××¡×œ×•×œ ×${origin} ×œ${destination}</p>
              <p>×× × ×‘×“×•×§ ××ª ×”×¤×¨×˜×™× ××• ×¤× ×” ×œ×©×™×¨×•×ª ×œ×§×•×—×•×ª</p>
            </div>
          `;
          document.getElementById('whatsapp-btn').style.display = 'none';
        }
      }

      // ×”×¦×’×ª ×¤×¨×˜×™ ×”××¡×œ×•×œ
      function displayRouteDetails(route) {
        document.getElementById('search-results').style.display = 'block';

        let html = `<div class="route-info"><h3>${route.route}</h3>`;

        // ×¤×¨×˜×™ ×”××¡×œ×•×œ
        if (route.km) {
          html += `<div class="detail-item"><strong>××¨×—×§ ××©×•×¢×¨:</strong> ${route.km} ×§"×</div>`;
        }

        if (route.waitTimeSides) {
          html += `<div class="detail-item"><strong>×–××Ÿ ×”××ª× ×” ×¦×“×“×™×:</strong> ${route.waitTimeSides} ×“×§×•×ª</div>`;
        }

        // ××—×™×¨×™ ×¨×›×‘×™×
        html += '<div class="prices-section"><h4>××—×™×¨×™×:</h4>';

        if (route.vehicles?.car4) {
          html += `<div class="price-item">ğŸš— <strong>×¨×›×‘ 4 ××§×•××•×ª:</strong> â‚ª${route.vehicles.car4}`;
          if (route.vehiclesSides?.car4) {
            html += ` (×¦×“×“×™×: â‚ª${route.vehiclesSides.car4})`;
          }
          html += '</div>';
        }

        if (route.vehicles?.car6) {
          html += `<div class="price-item">ğŸš <strong>×¨×›×‘ 6 ××§×•××•×ª:</strong> â‚ª${route.vehicles.car6}`;
          if (route.vehiclesSides?.car6) {
            html += ` (×¦×“×“×™×: â‚ª${route.vehiclesSides.car6})`;
          }
          html += '</div>';
        }

        if (route.vehicles?.car6plus) {
          html += `<div class="price-item">ğŸš <strong>×¨×›×‘ 6 ××§×•××•×ª ××¨×•×•×—:</strong> â‚ª${route.vehicles.car6plus}`;
          if (route.vehiclesSides?.car6plus) {
            html += ` (×¦×“×“×™×: â‚ª${route.vehiclesSides.car6plus})`;
          }
          html += '</div>';
        }

        html += '</div></div>';

        document.getElementById('route-details').innerHTML = html;
      }

      // ×©×™×ª×•×£ ×‘×•×•×˜×¡××¤
      function shareToWhatsApp() {
        if (!currentRoute) return;

        let message = `ğŸš— ×¤×¨×˜×™ ××¡×œ×•×œ: ${currentRoute.route}\n`;

        if (currentRoute.km) message += `ğŸ“ ××¨×—×§ ××©×•×¢×¨: ${currentRoute.km} ×§"×\n`;
        if (currentRoute.waitTimeSides) message += `â³ ×–××Ÿ ×”××ª× ×” ×¦×“×“×™×: ${currentRoute.waitTimeSides} ×“×§×•×ª\n`;

        message += '\nğŸ’° ××—×™×¨×™×:\n';

        if (currentRoute.vehicles?.car4) {
          message += `ğŸš— ×¨×›×‘ 4 ××§×•××•×ª: â‚ª${currentRoute.vehicles.car4}`;
          if (currentRoute.vehiclesSides?.car4) {
            message += ` (×¦×“×“×™×: â‚ª${currentRoute.vehiclesSides.car4})`;
          }
          message += '\n';
        }

        if (currentRoute.vehicles?.car6) {
          message += `ğŸš ×¨×›×‘ 6 ××§×•××•×ª: â‚ª${currentRoute.vehicles.car6}`;
          if (currentRoute.vehiclesSides?.car6) {
            message += ` (×¦×“×“×™×: â‚ª${currentRoute.vehiclesSides.car6})`;
          }
          message += '\n';
        }

        if (currentRoute.vehicles?.car6plus) {
          message += `ğŸš ×¨×›×‘ 6 ××§×•××•×ª ××¨×•×•×—: â‚ª${currentRoute.vehicles.car6plus}`;
          if (currentRoute.vehiclesSides?.car6plus) {
            message += ` (×¦×“×“×™×: â‚ª${currentRoute.vehiclesSides.car6plus})`;
          }
          message += '\n';
        }

        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
      }

      // ××™×¨×•×¢×™ ××§×œ×“×ª ×œ×—×™×¤×•×© ××”×™×¨
      document.getElementById('origin').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('destination').focus();
        }
      });

      document.getElementById('destination').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchRoute();
        }
      });

      // ×˜×¢×™× ×ª ×”××¡×œ×•×œ×™× ×‘×¢×ª ×˜×¢×™× ×ª ×”×“×£
      document.addEventListener('DOMContentLoaded', loadRoutes);
    </script>
  </body>
</html>